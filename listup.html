<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script type="module">
      import { serach, fetchSubjectList, keywardSearch } from './src/search.js';
      const defaultSerachQuery = `SELECT DISTINCT ?book WHERE { }`;
      const serachTemplateQuery = `SELECT DISTINCT ?book WHERE {%query%}`;
      function createCardsHtml(books) {
        const articles = Array.from(books)
          .map(([key, value]) => {
            const bookImgUrl = `https://ndlsearch.ndl.go.jp/thumbnail/${value.get(
              'isbn'
            )}.jpg`;

            const bookFigureTemplate = `
      <figure class="image is-4by3 is-skeleton">
          <img
            src="${bookImgUrl}"
            alt="${
              value.get('title') == ''
                ? value.get('title')
                : value.get('bookIri')
            }: 書影"
          />
        </figure>
      `;
            const bookCardTemplate = `
    <article class="cell card">
      <div class="card-image">
        ${bookFigureTemplate}
      </div>
      <div class="card-content">
        <p class="title is-5">${
          value.get('title') != '' ? value.get('title') : value.get('bookIri')
        }</p>
        <p class="subtitle is-6">${value.get('creators')}</p>
        <div class="content is-size-7">
          ${Array.from(value.get('subjects'))
            .map(
              ([iri, label]) =>
                `<a href="${iri}" target="_blank" rel="noopener noreferrer"><span class="tag">${label}</span></a>`
            )
            .join('')}
        </div>
      </div>
    </article>
  `;
            return bookCardTemplate;
          })
          .join('');
        return articles;
      }
      window.addEventListener('DOMContentLoaded', async () => {
        //初期化
        document.getElementById('searchQuery').value = defaultSerachQuery;

        //subjectのリストを、htmlのselectにしてdomに追加する^^^^^^^^^^^^^^^^^^^
        //subjectのリストを取得
        const subjectList = await fetchSubjectList();
        //htmlに変換
        const select = document.createElement('select');
        (() => {
          const option = document.createElement('option');
          option.value = ''; // Set the key as the value
          option.textContent = '主題で絞り込む'; // Use the value as the display text
          select.appendChild(option);
        })();
        subjectList.forEach((value, key) => {
          const option = document.createElement('option');
          option.value = key; // Set the key as the value
          option.textContent = value; // Use the value as the display text
          select.appendChild(option);
        });
        const subjectSelectArea = document.getElementById('subjectSelectArea');

        // Append the select element to the div
        if (subjectSelectArea) {
          subjectSelectArea.appendChild(select);
        } else {
          console.error('Element with id "subjectSelectArea" not found');
        }
        //------------------

        // sparql生成のためのオブジェクト(詳細検索)

        // keyword, subjectlist

        //subjectlistからなにかが選択されたときの処理
        subjectSelectArea
          .querySelector('select')
          .addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            if (selectedValue === '') {
              document.getElementById('searchQuery').value = defaultSerachQuery;
            } else {
              console.log('選択された値:', selectedValue);
              console.log(`?book dcterms:subject <${selectedValue}> .`);
              document.getElementById('searchQuery').value =
                serachTemplateQuery.replace(
                  '%query%',
                  `?book dcterms:subject <${selectedValue}> .`
                );
            }
          });
        //詳細検索時の処理
        document
          .getElementById('searchButton')
          .addEventListener('click', () => {
            const serachQuery = document.getElementById('searchQuery').value;
            console.log(serachQuery);
            serach(serachQuery).then((books) => {
              //htmlを生成し、domに書き込み
              document.getElementById(
                'searchResNum'
              ).innerHTML = `<p>取得件数：${books.size}</p>`;
              const articles = createCardsHtml(books);
              console.log('start write');
              document.getElementById('bookList').innerHTML = articles;
              //skelton
              const skeletonImages =
                document.querySelectorAll('.image.is-skeleton');
              skeletonImages.forEach((container) => {
                const img = container.querySelector('img');
                console.log(img);
                if (img) {
                  img.addEventListener('load', () => {
                    container.classList.remove('is-skeleton');
                  });
                }
              });
            });
          });
        //
        document
          .getElementById('searchKeywardButton')
          .addEventListener('click', () => {
            //keywardの取得
            const keywards = document
              .getElementById('keywardInput')
              .value.split(/[\u{20}\u{3000}]/u);
            keywardSearch(keywards).then((books) => {
              //htmlを生成し、domに書き込み
              document.getElementById(
                'searchResNum'
              ).innerHTML = `<p>取得件数：${books.size}</p>`;
              const articles = createCardsHtml(books);
              console.log('start write');
              document.getElementById('bookList').innerHTML = articles;
              //skelton
              const skeletonImages =
                document.querySelectorAll('.image.is-skeleton');
              skeletonImages.forEach((container) => {
                const img = container.querySelector('img');
                console.log(img);
                if (img) {
                  img.addEventListener('load', () => {
                    container.classList.remove('is-skeleton');
                  });
                }
              });
            });
          });
      });
    </script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
    />
    <style>
      main {
        margin: 20px;
      }
      .card-image img {
        object-fit: contain;
      }
      .card {
        padding: 0.5rem;
      }
      .cell {
        max-width: 18rem;
      }
      #serachResult {
        margin-top: 1rem;
        border-top: 1px solid #333;
      }
    </style>
  </head>
  <body>
    <header class="columns is-mobile">
      <div class="column is-four-fifths is-size-4">
        古崎研究室 蔵書検索システム
      </div>
      <div class="column">Auto</div>
      <div class="column">Auto</div>
    </header>
    <main>
      <div>
        <div class="columns is-mobile">
          <div class="column is-9 is-offset-1">
            <input
              id="keywardInput"
              class="input is-rounded"
              type="text"
              placeholder="keyward検索（タイトルと著者の部分一致検索）"
            />
          </div>
          <div class="column">
            <button id="searchKeywardButton" class="button">検索</button>
          </div>
        </div>

        <div style="overflow: visible"></div>
        <details style="overflow: visible; height: auto">
          <summary>詳細検索</summary>
          <div class="columns is-mobile">
            <div class="column select column is-2" id="subjectSelectArea"></div>
          </div>
          <div class="columns is-mobile">
            <div class="column">
              <details>
                <summary>SPARQL</summary>
                <textarea
                  id="searchQuery"
                  class="textarea"
                  placeholder="検索クエリを入力してください。SELECTで?bookを指定してください"
                ></textarea>
              </details>
            </div>
          </div>
          <div class="columns is-mobile">
            <div class="column">
              <button id="searchButton" class="button">検索</button>
            </div>
          </div>
        </details>
      </div>
      <!-- 検索結果 -->
      <div id="serachResult">
        <div id="searchResNum"></div>
        <div id="bookList" class="grid is-col-min-11"></div>
      </div>
    </main>
    <footer></footer>
  </body>
</html>
